<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>SFU test</title>

  <style>
    body {
      display: flex;
      gap: 16px;
    }
    video {
      width: 45%;
      background: black;
    }
  </style>
</head>

<body>
<video id="local" autoplay muted playsinline></video>
<video id="remote" autoplay playsinline></video>

<script>
  const clientId = prompt("client id (alice / bob)");
  const room = "room1";

  const ws = new WebSocket(
          "ws://localhost:8080/ws?client_id=" + clientId
  );

  let pc;
  let makingOffer = false;
  const polite = true; // SFU-ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ â†’ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ polite

  // ðŸ”´ Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ ICE, Ð¿Ñ€Ð¸ÑˆÐµÐ´ÑˆÐ¸Ñ… Ð”Ðž remoteDescription
  const pendingCandidates = [];

  function flushCandidates() {
    if (!pc || !pc.remoteDescription) return;
    while (pendingCandidates.length) {
      const c = pendingCandidates.shift();
      pc.addIceCandidate(c).catch(e =>
              console.error("ICE flush error", e)
      );
    }
  }

  // ---------- WS ----------
  ws.onmessage = async (event) => {
    const msg = JSON.parse(event.data);
    console.log("WS <-", msg.type, "state=", pc?.signalingState);

    // ---------- OFFER ----------
    if (msg.type === "offer") {
      const offer = msg.payload;

      const offerCollision =
              makingOffer || pc.signalingState !== "stable";

      if (offerCollision) {
        if (!polite) return;
        console.log("GLARE â†’ rollback");
        await pc.setLocalDescription({ type: "rollback" });
      }

      await pc.setRemoteDescription(offer);
      flushCandidates();

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      ws.send(JSON.stringify({
        type: "answer",
        to: "sfu",
        from: clientId,
        room,
        payload: pc.localDescription
      }));
      return;
    }

    // ---------- ANSWER ----------
    let lastAnswerSdp = null;

    if (msg.type === "answer") {
      const ans = msg.payload;
      console.log("WS <- answer, state =", pc.signalingState);

      // 1) ÐµÑÐ»Ð¸ ÑƒÐ¶Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐ»Ð¸ ÑÑ‚Ð¾Ñ‚ Ð¶Ðµ answer â€” Ð¸Ð³Ð½Ð¾Ñ€
      const sdp = ans && ans.sdp ? ans.sdp : JSON.stringify(ans);
      if (lastAnswerSdp === sdp) {
        console.warn("Duplicate answer ignored");
        return;
      }

      // 2) ÐµÑÐ»Ð¸ ÑƒÐ¶Ðµ ÑÑ‚Ð¾Ð¸Ñ‚ remote answer â€” Ð¸Ð³Ð½Ð¾Ñ€
      if (pc.remoteDescription && pc.remoteDescription.type === "answer") {
        console.warn("Remote answer already set, ignoring");
        return;
      }

      // 3) Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÑ‚ÑŒ answer Ð¼Ð¾Ð¶Ð½Ð¾ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ñƒ Ð½Ð°Ñ ÐµÑÑ‚ÑŒ local offer
      if (!pc.localDescription || pc.localDescription.type !== "offer") {
        console.warn("No local offer, ignoring answer");
        return;
      }

      try {
        await pc.setRemoteDescription(ans);
        lastAnswerSdp = sdp;
        flushCandidates();
      } catch (e) {
        // ÐµÑÐ»Ð¸ ÑƒÐ¶Ðµ stable/answer ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼
        console.warn("setRemoteDescription(answer) failed, ignoring:", e);
      }
      return;
    }



    // ---------- ICE ----------
    if (msg.type === "candidate") {
      const cand = msg.payload;
      if (!pc.remoteDescription) {
        pendingCandidates.push(cand);
        return;
      }
      try {
        await pc.addIceCandidate(cand);
      } catch (e) {
        console.error("ICE error", e);
      }
      return;
    }
  };

  // ---------- OPEN ----------
  ws.onopen = async () => {
    console.log("WS connected");

    // JOIN
    ws.send(JSON.stringify({
      type: "join",
      room,
      client_id: clientId
    }));

    pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    // ---------- REMOTE TRACK ----------
    pc.ontrack = (event) => {
      console.log("ðŸŽ¥ CLIENT ontrack", event.streams[0].id);
      document.getElementById("remote").srcObject = event.streams[0];
    };

    // ---------- ICE OUT ----------
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        ws.send(JSON.stringify({
          type: "candidate",
          to: "sfu",
          from: clientId,
          room,
          payload: event.candidate
        }));
      }
    };

    // ---------- MEDIA ----------
    const stream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    });

    document.getElementById("local").srcObject = stream;

    stream.getTracks().forEach(track => {
      pc.addTrack(track, stream);
    });

    // ---------- INITIAL OFFER ----------
    try {
      makingOffer = true;
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      ws.send(JSON.stringify({
        type: "offer",
        to: "sfu",
        from: clientId,
        room,
        payload: pc.localDescription
      }));
    } finally {
      makingOffer = false;
    }
  };
</script>
</body>
</html>
