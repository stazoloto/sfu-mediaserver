<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>SFU test</title>
  <style>
    body {
      display: flex;
      gap: 20px;
    }
    video {
      width: 45%;
      background: black;
    }
  </style>
</head>

<body>
  <!-- –õ–û–ö–ê–õ–¨–ù–û–ï –í–ò–î–ï–û -->
  <video id="local" autoplay muted playsinline></video>

  <!-- –£–î–ê–õ–Å–ù–ù–û–ï –í–ò–î–ï–û -->
  <video id="remote" autoplay muted playsinline></video>

  <script>
    const clientId = prompt("client id (alice / bob)");
    const room = "room1";

    const ws = new WebSocket(
      "ws://localhost:8080/ws?client_id=" + clientId
    );

    let pc;

    // ---------- WS HANDLER ----------
    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);
      console.log("WS ‚Üê", msg.type);

      // OFFER –û–¢ SFU (renegotiation)
      if (msg.type === "offer") {
        console.log("WS <- offer, state=", pc.signalingState);

        if (pc.signalingState !== "stable") {
          console.log("glare: rollback local offer");
          await pc.setLocalDescription({ type:"rollback" })
        }

        await pc.setRemoteDescription(msg.payload);

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        ws.send(JSON.stringify({
          type: "answer",
          to: "sfu",
          from: clientId,
          room: room,
          payload: answer
        }));
      }

      // ANSWER –ù–ê INITIAL OFFER
      if (msg.type === "answer") {
        console.log("‚úÖ answer received");
        await pc.setRemoteDescription(msg.payload);
      }

      // ICE
      if (msg.type === "candidate") {
        try {
          await pc.addIceCandidate(msg.payload);
        } catch (e) {
          console.error("ICE error", e);
        }
      }
    };

    ws.onopen = async () => {
      console.log("WS connected");

      // 1Ô∏è‚É£ JOIN
      ws.send(JSON.stringify({
        type: "join",
        room: room,
        client_id: clientId
      }));

      // 2Ô∏è‚É£ PEER CONNECTION
      pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      // üî¥ REMOTE TRACK
      pc.ontrack = (event) => {
        console.log("üé• CLIENT ontrack", event.streams[0].id);
        const remoteVideo = document.getElementById("remote");
        remoteVideo.srcObject = event.streams[0];
      };

      // üî¥ ICE
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({
            type: "candidate",
            to: "sfu",
            from: clientId,
            room: room,
            payload: event.candidate
          }));
        }
      };

      // 3Ô∏è‚É£ GET USER MEDIA
      const stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      });

      document.getElementById("local").srcObject = stream;

      stream.getTracks().forEach(track => {
        pc.addTrack(track, stream);
      });

      // 4Ô∏è‚É£ INITIAL OFFER
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      ws.send(JSON.stringify({
        type: "offer",
        to: "sfu",
        from: clientId,
        room: room,
        payload: offer
      }));
    };
  </script>
</body>
</html>